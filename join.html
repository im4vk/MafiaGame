<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Join Mafia Game</title>
    <link rel="stylesheet" href="./index.css">
    <style>
        body {
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .join-container {
            max-width: 500px;
            width: 100%;
            margin: 0 auto;
        }
        
        .status-message {
            padding: 15px;
            border-radius: 12px;
            margin: 15px 0;
            font-weight: 600;
            text-align: center;
        }
        
        .success {
            background: rgba(56, 239, 125, 0.2);
            border: 2px solid rgba(56, 239, 125, 0.5);
            color: #38ef7d;
        }
        
        .error {
            background: rgba(255, 107, 107, 0.2);
            border: 2px solid rgba(255, 107, 107, 0.5);
            color: #ff6b6b;
        }
        
        .waiting {
            background: rgba(107, 207, 255, 0.2);
            border: 2px solid rgba(107, 207, 255, 0.5);
            color: #6bcfff;
        }
        
        #join-form {
            margin: 30px 0;
        }
        
        .large-button {
            width: 100%;
            max-width: 350px;
            height: 60px;
            font-size: 20px;
            margin: 15px auto;
            display: block;
        }
    </style>
</head>
<body>
    <div class="join-container">
        <h1>üé≠ Join Mafia Game</h1>
        <h3 id="room-code-display"></h3>
        
        <div id="status-area"></div>
        
        <div id="join-form">
            <div class="input-container">
                <input type="text" id="player-name-join" placeholder="üë§ Enter your name..." autocomplete="off" style="width: 100%; max-width: 350px;" />
            </div>
            <button onclick="joinGame()" class="large-button" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
                ‚úÖ Join Game
            </button>
        </div>
        
        <div id="player-list-area" style="display: none;">
            <h3>üë• Players in Room:</h3>
            <div id="joined-players" style="margin: 20px 0;"></div>
            <p style="color: #6bcfff; font-size: 14px;">Waiting for host to start the game...</p>
        </div>
    </div>
    
    <script>
        const STORAGE_KEYS = {
            ROOM_DATA: 'mafia_room_'
        };
        
        let roomCode = null;
        let playerName = null;
        let syncInterval = null;
        
        // Get room code from URL
        function getRoomCodeFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('room');
        }
        
        // Capitalize name properly (Title Case)
        function capitalizeName(name) {
            return name.trim()
                .toLowerCase()
                .split(' ')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                .join(' ');
        }
        
        // Load room data from multiple sources
        function loadRoomData(code) {
            // Try localStorage first
            let roomData = localStorage.getItem(STORAGE_KEYS.ROOM_DATA + code);
            if (roomData) {
                try {
                    const data = JSON.parse(roomData);
                    // Check if room is closed
                    if (data.status === 'closed') {
                        return { ...data, isClosed: true };
                    }
                    return data;
                } catch (e) {
                    console.error("Error loading room data from localStorage:", e);
                }
            }
            
            // Try sessionStorage
            roomData = sessionStorage.getItem('mafia_current_room');
            if (roomData) {
                try {
                    const data = JSON.parse(roomData);
                    if (data.code === code) {
                        if (data.status === 'closed') {
                            return { ...data, isClosed: true };
                        }
                        return data;
                    }
                } catch (e) {
                    console.error("Error loading room data from sessionStorage:", e);
                }
            }
            
            // Create new room data if not found (for first joiner)
            return {
                code: code,
                players: [],
                timestamp: Date.now(),
                status: 'open'
            };
        }
        
        // Save room data to multiple storages
        function saveRoomData(code, data) {
            try {
                const jsonData = JSON.stringify(data);
                localStorage.setItem(STORAGE_KEYS.ROOM_DATA + code, jsonData);
                sessionStorage.setItem('mafia_current_room', jsonData);
                
                // Also try to communicate with host window if opened from same origin
                if (window.opener && !window.opener.closed) {
                    try {
                        window.opener.postMessage({
                            type: 'PLAYER_JOINED',
                            roomCode: code,
                            players: data.players
                        }, '*');
                    } catch (e) {
                        // Cross-origin, ignore
                    }
                }
            } catch (e) {
                console.error("Error saving room data:", e);
            }
        }
        
        // Join the game
        function joinGame() {
            const nameInput = document.getElementById('player-name-join');
            const rawName = nameInput.value.trim();
            
            if (!rawName) {
                showStatus('‚ö†Ô∏è Please enter your name!', 'error');
                return;
            }
            
            if (rawName.length < 2) {
                showStatus('‚ö†Ô∏è Name must be at least 2 characters!', 'error');
                return;
            }
            
            if (rawName.length > 20) {
                showStatus('‚ö†Ô∏è Name must be less than 20 characters!', 'error');
                return;
            }
            
            if (!/^[a-zA-Z\s'-]+$/.test(rawName)) {
                showStatus('‚ö†Ô∏è Name should only contain letters!', 'error');
                return;
            }
            
            playerName = capitalizeName(rawName);
            
            // Load room data
            const roomData = loadRoomData(roomCode);
            
            if (!roomData) {
                showStatus('‚ö†Ô∏è Room not found or expired!', 'error');
                return;
            }
            
            // Check if room is closed
            if (roomData.isClosed || roomData.status === 'closed') {
                showStatus('üö´ This room is closed! The host has ended this session.', 'error');
                document.getElementById('join-form').style.display = 'none';
                return;
            }
            
            // Check if name already exists
            if (roomData.players.some(p => p.toLowerCase() === playerName.toLowerCase())) {
                showStatus(`‚ö†Ô∏è Player "${playerName}" already joined!`, 'error');
                return;
            }
            
            // Add player to room
            roomData.players.push(playerName);
            roomData.timestamp = Date.now();
            saveRoomData(roomCode, roomData);
            
            // Show success with instructions
            const successMsg = `
                <div style="text-align: center;">
                    <h2 style="color: #38ef7d; margin-bottom: 15px;">‚úÖ Successfully Joined!</h2>
                    <p style="color: #fff; font-size: 18px; font-weight: 600;">Welcome, ${playerName}!</p>
                    <div style="background: rgba(255, 217, 61, 0.1); padding: 15px; border-radius: 10px; margin: 20px 0; border: 2px solid rgba(255, 217, 61, 0.3);">
                        <p style="color: #ffd93d; font-size: 14px; font-weight: 600;">‚ö†Ô∏è IMPORTANT NEXT STEP:</p>
                        <p style="color: #fff; font-size: 13px; margin-top: 10px;">
                            Tell the HOST (person with the main game) your name: <strong style="color: #38ef7d;">${playerName}</strong>
                        </p>
                        <p style="color: #fff; font-size: 13px; margin-top: 5px;">
                            They need to manually add you using the "‚ûï Add Player" button.
                        </p>
                    </div>
                    <p style="color: #6bcfff; font-size: 12px;">Keep this page open until the game starts!</p>
                </div>
            `;
            
            showStatus(successMsg, 'success');
            document.getElementById('join-form').style.display = 'none';
            document.getElementById('player-list-area').style.display = 'block';
            
            // Start syncing
            startSyncInterval();
            updatePlayerList(roomData.players);
        }
        
        // Show status message
        function showStatus(message, type) {
            const statusArea = document.getElementById('status-area');
            statusArea.innerHTML = `<div class="status-message ${type}">${message}</div>`;
        }
        
        // Update player list
        function updatePlayerList(players) {
            const playerListDiv = document.getElementById('joined-players');
            playerListDiv.innerHTML = '';
            
            players.forEach(name => {
                const playerDiv = document.createElement('div');
                playerDiv.style.cssText = 'background: rgba(102, 126, 234, 0.2); padding: 12px; margin: 8px 0; border-radius: 10px; border: 2px solid rgba(102, 126, 234, 0.4);';
                playerDiv.innerHTML = `<span style="font-size: 18px; font-weight: 600;">${name === playerName ? 'üë§ ' + name + ' (You)' : name}</span>`;
                playerListDiv.appendChild(playerDiv);
            });
        }
        
        // Sync with room
        function syncWithRoom() {
            const roomData = loadRoomData(roomCode);
            if (roomData && roomData.players) {
                updatePlayerList(roomData.players);
            }
        }
        
        // Start sync interval
        function startSyncInterval() {
            if (syncInterval) clearInterval(syncInterval);
            syncInterval = setInterval(syncWithRoom, 2000);
        }
        
        // Initialize
        window.addEventListener('load', function() {
            roomCode = getRoomCodeFromURL();
            
            if (!roomCode) {
                showStatus('‚ö†Ô∏è No room code provided!', 'error');
                document.getElementById('join-form').style.display = 'none';
                return;
            }
            
            document.getElementById('room-code-display').innerText = `Room: ${roomCode}`;
            
            // Load room data - create if doesn't exist
            let roomData = loadRoomData(roomCode);
            
            // Check if room is closed
            if (roomData && (roomData.isClosed || roomData.status === 'closed')) {
                showStatus('üö´ This room is closed! The host has ended this session. Please ask the host to create a new room.', 'error');
                document.getElementById('join-form').style.display = 'none';
                return;
            }
            
            // Always allow joining - the loadRoomData now creates empty room if not exists
            if (!roomData || !roomData.players) {
                roomData = {
                    code: roomCode,
                    players: [],
                    timestamp: Date.now(),
                    status: 'open'
                };
                saveRoomData(roomCode, roomData);
            }
            
            showStatus(`Ready to join room: ${roomCode}`, 'waiting');
            
            // Enter key support
            document.getElementById('player-name-join').addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    joinGame();
                }
            });
        });
    </script>
</body>
</html>

